
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Silent substitution with STLAB &#8212; PyPlr v1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API documentation" href="07_api.html" />
    <link rel="prev" title="Matching spectra for a-opic irradiance with STLAB" href="06c_finding_stlab_settings.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Silent-substitution-with-STLAB">
<h1>Silent substitution with STLAB<a class="headerlink" href="#Silent-substitution-with-STLAB" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://www.frontiersin.org/articles/10.3389/fneur.2018.00941/full">Silent substitution</a> is an elegant technique that uses pairs of lights to stimulate a specific class of retinal photoreceptor whilst maintaining a constant level of activation in others. The challenge with this technique is finding the settings for a stimulation device to produce light stimuli that satisfy the spectral requirements and constraints. Suppose we are interested in how the melanopsin-containing ipRGCs contribute
to pupil control and that we want to administer a light stimulus that targets melanopsin without changing the activation of the cone photoreceptors, so as to be sure that the resulting pupil modulation is driven purely by ipRGC activity. For simplicity’s sake we can assume the rods are saturated. To accomplish our goal we need to find the settings for a background spectrum and a modulation spectrum where both spectra have identical S-, M-, and L-opic irradiance, but where the modulation spectrum
has higher melanopic irradiance. Fundamentally, this is a constrained numerical optimisation problem that can be expressed formally as:</p>
<p><span class="math">\begin{equation}
\begin{array}{rrclcl}
& \underset{x}{\text{minimize}}
& & f(x) \\
& \text{subject to}
& & g^{L} \le g(x) \le g^{U}
\end{array}
\end{equation}</span></p>
<p>where <span class="math notranslate nohighlight">\(f(x)\)</span> is the objective function which aims to minimise negative (i.e., maximise) melanopsin contrast, and <span class="math notranslate nohighlight">\(g(x)\)</span> is a function that calculates cone contrast, where <span class="math notranslate nohighlight">\(g^{L}\)</span> and <span class="math notranslate nohighlight">\(g^{U}\)</span> should be zero. In both cases, <span class="math notranslate nohighlight">\(x\)</span> is a vector containing the weights for the LED settings. What follows is a basic example of how to find a solution to this problem for STLAB, which has 10 LED channels.</p>
<p>First, we create a calibration context which gives us access to the forward model of STLAB.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">pyplr.calibrate</span> <span class="kn">import</span> <span class="n">CalibrationContext</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;notebook&#39;</span><span class="p">)</span>

<span class="n">cc</span> <span class="o">=</span> <span class="n">CalibrationContext</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="s1">&#39;../data/S2_corrected_oo_spectra.csv&#39;</span><span class="p">,</span> <span class="n">binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">plot_calibrated_spectra</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06d_silent_substitution_STLAB_1_0.png" src="_images/06d_silent_substitution_STLAB_1_0.png" />
</div>
</div>
<p>Now we can define the problem. The approach used here is to encapsulate the problem in a class with the <em>a</em>-opic irradiance data for STLAB. Note that contrast is defined simply as the fractional difference of activation of a photopigment around a background:</p>
<p><span class="math">\begin{equation}
\frac{I_{modulation} − I_{background}}{I_{background}}
\end{equation}</span></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="k">class</span> <span class="nc">OptimisationProblem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aopic</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aopic</span> <span class="o">=</span> <span class="n">aopic</span>

    <span class="k">def</span> <span class="nf">smlri_calculator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculates a-opic irradiance for the given weights.</span>
<span class="sd">        The first 10 values in weights define the background</span>
<span class="sd">        spectrum and the second 10 values define the modulation&#39;&#39;&#39;</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">modulation</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
        <span class="n">bg_smlri</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mod_smlri</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">led</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aopic</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">led</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">/</span> <span class="mi">4095</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aopic</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">led</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
            <span class="n">bg_smlri</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">background</span><span class="p">[</span><span class="n">led</span><span class="p">])</span>
            <span class="n">mod_smlri</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">modulation</span><span class="p">[</span><span class="n">led</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bg_smlri</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aopic</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mod_smlri</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aopic</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculates negative melanopsin contrast for background</span>
<span class="sd">        and modulation spectra. We want to minimise this.&#39;&#39;&#39;</span>
        <span class="n">bg_smlri</span><span class="p">,</span> <span class="n">mod_smlri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smlri_calculator</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="p">(</span><span class="n">mod_smlri</span><span class="o">.</span><span class="n">Mel</span><span class="o">-</span><span class="n">bg_smlri</span><span class="o">.</span><span class="n">Mel</span><span class="p">)</span> <span class="o">/</span> <span class="n">bg_smlri</span><span class="o">.</span><span class="n">Mel</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">contrast</span>

    <span class="k">def</span> <span class="nf">cone_contrast_constraint_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculates S-, M-, and L-opic contrast for background</span>
<span class="sd">        and modulation spectra. We want to this to be zero&#39;&#39;&#39;</span>
        <span class="n">bg_smlri</span><span class="p">,</span> <span class="n">mod_smlri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smlri_calculator</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">mod_smlri</span><span class="o">.</span><span class="n">S</span><span class="o">-</span><span class="n">bg_smlri</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="o">/</span> <span class="n">bg_smlri</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">mod_smlri</span><span class="o">.</span><span class="n">M</span><span class="o">-</span><span class="n">bg_smlri</span><span class="o">.</span><span class="n">M</span><span class="p">)</span> <span class="o">/</span> <span class="n">bg_smlri</span><span class="o">.</span><span class="n">M</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">mod_smlri</span><span class="o">.</span><span class="n">L</span><span class="o">-</span><span class="n">bg_smlri</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">/</span> <span class="n">bg_smlri</span><span class="o">.</span><span class="n">L</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">contrast</span>

    <span class="k">def</span> <span class="nf">weights_to_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Turns weights to 12-bit STLAB settings.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">*</span><span class="mi">4095</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]],</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">*</span><span class="mi">4095</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<p>To perform the optimisation, we will use <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize">scipy.optimize.minimize</a> with the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.minimize-slsqp.html">SLSQP</a> solver. SLSQP uses <a class="reference external" href="https://en.wikipedia.org/wiki/Sequential_quadratic_programming">sequential quadratic programming</a>, an iterative method that is ideally suited to solving constrained nonlinear optimsation problems like ours.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">Bounds</span>
<span class="kn">from</span> <span class="nn">pyplr.CIE</span> <span class="kn">import</span> <span class="n">get_CIES026</span>

<span class="c1"># A random starting point for the optimisation</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># The aopic data from original spectrometer measurements</span>
<span class="n">sss</span> <span class="o">=</span> <span class="n">get_CIES026</span><span class="p">(</span><span class="n">asdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sss</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">aopic</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sss</span><span class="p">)</span>

<span class="c1"># Create an instance of our optimisation problem</span>
<span class="n">op</span> <span class="o">=</span> <span class="n">OptimisationProblem</span><span class="p">(</span><span class="n">aopic</span><span class="p">)</span>

<span class="c1"># Define and equality constraint for the cones</span>
<span class="c1"># (i.e., contrast must be zero)</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">cone_contrast_constraint_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># The bounds should be between 0-1, otherwise we are outside the</span>
<span class="c1"># gamut of the device</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">Bounds</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">20</span><span class="p">))</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">20</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Do the optimsation</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">objective_function</span><span class="p">,</span>
               <span class="n">x0</span><span class="p">,</span>
               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
               <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
               <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">},</span>
               <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

<span class="c1"># Print the result</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimisation result:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="c1"># Print contrast for results</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Melanopsin contrast is: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">op</span><span class="o">.</span><span class="n">objective_function</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cone contrast is: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">op</span><span class="o">.</span><span class="n">cone_contrast_constraint_function</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span>


</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimisation result:
     fun: -1.1262980001283986
     jac: array([ 1.68524863e+00,  3.15193579e-01,  1.72366345e+00,  1.94611071e+00,
        1.02473636e+00,  2.61568606e-01,  1.12671651e+00,  2.99931169e-01,
        1.14196539e-03,  6.18398190e-04, -1.88550070e-01, -7.49940321e-01,
       -1.89080393e+00, -1.62490889e-01, -1.57686652e+00, -1.23016015e-01,
       -2.05165818e-01, -2.35104889e-01, -2.52726525e-02, -5.31006455e-02])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 2114
     nit: 94
    njev: 94
  status: 0
 success: True
       x: array([2.72832879e-01, 5.55555807e-01, 6.44788109e-14, 7.33560916e-14,
       3.21556559e-12, 4.75574157e-14, 3.11704172e-01, 3.48394141e-01,
       7.47335280e-13, 1.86972226e-15, 3.24115162e-13, 5.59009258e-04,
       2.52874586e-01, 7.16086550e-01, 4.24668885e-01, 2.25413334e-13,
       4.38771435e-13, 2.51358975e-01, 9.80844739e-01, 1.00000000e+00])
Melanopsin contrast is: -1.1262980001283986
Cone contrast is: [2.77454853e-11 2.81393038e-12 4.59119978e-11]
</pre></div></div>
</div>
<p>Success. The optimisation has found a result where cones are silent and melanopsin contrast is 112%. We can~ plot the spectra and <em>a</em>-opic irradiances to see what the solution looks like.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Convert the solution to 12-bit device settings for STLAB</span>
<span class="n">background_settings</span><span class="p">,</span> <span class="n">modulation_settings</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">weights_to_settings</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The background settings are: </span><span class="si">{</span><span class="n">background_settings</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The modulation settings are: </span><span class="si">{</span><span class="n">modulation_settings</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Predict the spectral power distributions</span>
<span class="n">background_spec</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_spd</span><span class="p">(</span><span class="n">background_settings</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">modulation_spec</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_spd</span><span class="p">(</span><span class="n">modulation_settings</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Predict aopic irradiances</span>
<span class="n">background_ao</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_aopic</span><span class="p">(</span><span class="n">background_settings</span><span class="p">)</span>
<span class="n">modulation_ao</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_aopic</span><span class="p">(</span><span class="n">modulation_settings</span><span class="p">)</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">background_ao</span><span class="p">,</span> <span class="n">modulation_ao</span><span class="p">])</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ao</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;stimulus&#39;</span><span class="p">]</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>

<span class="c1"># Plot the predicted spectra</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">380</span><span class="p">,</span> <span class="mi">781</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">background_spec</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">modulation_spec</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;stimulus&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;W/m$^2$/nm&#39;</span><span class="p">,</span>
       <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Wavelength (nm)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>

<span class="c1"># Plot the predicted a-opic irradiances</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ao</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span>
                  <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;W/m$^2$&#39;</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The background settings are: [1117, 2275, 0, 0, 0, 0, 1276, 1426, 0, 0]
The modulation settings are: [0, 2, 1035, 2932, 1739, 0, 0, 1029, 4016, 4094]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06d_silent_substitution_STLAB_7_1.png" src="_images/06d_silent_substitution_STLAB_7_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06d_silent_substitution_STLAB_7_2.png" src="_images/06d_silent_substitution_STLAB_7_2.png" />
</div>
</div>
<p>This is a good start, but it is unlikely to be the exact solution we are looking for, as SciPy’s SLSQP solver is a ‘local’ minimzer. This means that it will attempt to locate the nearest minimum to its starting point, which in our case was completely random. Suppose for example that we wanted our melanopic pulse to be at least 400% contrast. For this we would need to search for a better solution using <a class="reference external" href="https://en.wikipedia.org/wiki/Global_optimization">‘global’ optimisation</a>. One approach is
to use SciPy’s <a class="reference external" href="https://en.wikipedia.org/wiki/Basin-hopping">basinhopping</a> algorithm in conjunction with the SLSQP solver. This will conduct a series of local minimisations, each time starting at a different coordinates in the problem space. We can save all of the acceptable intermediate solutions and call off the search when we find a solution that has at least 400% melanopic contast.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">basinhopping</span>

<span class="c1"># A random starting point for the optimisation</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># The aopic data from original spectrometer measurements</span>
<span class="n">sss</span> <span class="o">=</span> <span class="n">get_CIES026</span><span class="p">(</span><span class="n">asdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sss</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">aopic</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sss</span><span class="p">)</span>

<span class="c1"># Create an instance of our optimisation problem</span>
<span class="n">op</span> <span class="o">=</span> <span class="n">OptimisationProblem</span><span class="p">(</span><span class="n">aopic</span><span class="p">)</span>

<span class="c1"># Define bounds of 0-1, which makes sure the settings are</span>
<span class="c1"># within the gamut of STLAB</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">Bounds</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">20</span><span class="p">))</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">20</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Define constraints and local minimizer</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span>
               <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">cone_contrast_constraint_function</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="n">minimizer_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;constraints&#39;</span><span class="p">:</span> <span class="n">constraints</span><span class="p">,</span>
                    <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="n">bounds</span><span class="p">,</span>
                    <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
                   <span class="p">}</span>

<span class="c1"># List to store valid solutions</span>
<span class="n">minima</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Callback function to give info on all minima found and</span>
<span class="c1"># call off the search when we hit a target melanopic contrast</span>
<span class="k">def</span> <span class="nf">print_fun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">accepted</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Melanopsin contrast at minimum: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">, accepted </span><span class="si">{</span><span class="n">accepted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
        <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">4.</span> <span class="ow">and</span> <span class="n">accepted</span><span class="p">:</span> <span class="c1"># the target is 400% contrast</span>
            <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Start the global search</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">basinhopping</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">objective_function</span><span class="p">,</span>
                   <span class="n">x0</span><span class="p">,</span>
                   <span class="n">minimizer_kwargs</span><span class="o">=</span><span class="n">minimizer_kwargs</span><span class="p">,</span>
                   <span class="n">niter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                   <span class="n">stepsize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">callback</span><span class="o">=</span><span class="n">print_fun</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Melanopsin contrast at minimum: -1.157205714211695, accepted True
Melanopsin contrast at minimum: -1.0333207541135296, accepted True
Melanopsin contrast at minimum: -1.1463763700733014, accepted True
Melanopsin contrast at minimum: -1.349362878365679, accepted True
Melanopsin contrast at minimum: -1.3000577322404925, accepted True
Melanopsin contrast at minimum: -1.6298963642832545, accepted True
Melanopsin contrast at minimum: -1.5531614465469152, accepted True
Melanopsin contrast at minimum: -1.6402950219928798, accepted True
Melanopsin contrast at minimum: -1.5055464302170414, accepted False
Melanopsin contrast at minimum: -2.5376813025601095, accepted True
Melanopsin contrast at minimum: -0.7473887793354929, accepted True
Melanopsin contrast at minimum: -1.7741800855251268, accepted True
Melanopsin contrast at minimum: -2.113277220497712, accepted True
Melanopsin contrast at minimum: -2.195097542530537, accepted True
Melanopsin contrast at minimum: -1.9454096886092744, accepted True
Melanopsin contrast at minimum: -0.9940588526698512, accepted False
Melanopsin contrast at minimum: -1.2108668262395486, accepted False
Melanopsin contrast at minimum: -1.4431648236090764, accepted True
Melanopsin contrast at minimum: -2.7305255211845596, accepted True
Melanopsin contrast at minimum: -2.1530870262550197, accepted True
Melanopsin contrast at minimum: -1.298445243730765, accepted False
Melanopsin contrast at minimum: -2.584598260615528, accepted True
Melanopsin contrast at minimum: -1.5602820185175494, accepted False
Melanopsin contrast at minimum: -1.1159782989449083, accepted True
Melanopsin contrast at minimum: -1.394129653899704, accepted True
Melanopsin contrast at minimum: -2.591339028312339, accepted True
Melanopsin contrast at minimum: -2.404574155601363, accepted True
Melanopsin contrast at minimum: -4.6240830130736335, accepted True
</pre></div></div>
</div>
<p>Good. We have found a solution that gives 462% melanopic contrast. As before, we can plot the spectra and <em>a</em>-opic irradiances to see how they look.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Convert the solution to 12-bit device settings for STLAB</span>
<span class="n">background_settings</span><span class="p">,</span> <span class="n">modulation_settings</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">weights_to_settings</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Predict the spectral power distributions</span>
<span class="n">background_spec</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_spd</span><span class="p">(</span><span class="n">background_settings</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">modulation_spec</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_spd</span><span class="p">(</span><span class="n">modulation_settings</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Predict aopic irradiances</span>
<span class="n">background_ao</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_aopic</span><span class="p">(</span><span class="n">background_settings</span><span class="p">)</span>
<span class="n">modulation_ao</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_aopic</span><span class="p">(</span><span class="n">modulation_settings</span><span class="p">)</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">background_ao</span><span class="p">,</span> <span class="n">modulation_ao</span><span class="p">])</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ao</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;stimulus&#39;</span><span class="p">]</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>

<span class="c1"># Plot the predicted spectra</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">380</span><span class="p">,</span> <span class="mi">781</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">background_spec</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">modulation_spec</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;stimulus&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;W/m$^2$/nm&#39;</span><span class="p">,</span>
       <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Wavelength (nm)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>

<span class="c1"># Plot the predicted a-opic irradiances</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ao</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span>
                  <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;W/m$^2$&#39;</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06d_silent_substitution_STLAB_11_0.png" src="_images/06d_silent_substitution_STLAB_11_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06d_silent_substitution_STLAB_11_1.png" src="_images/06d_silent_substitution_STLAB_11_1.png" />
</div>
</div>
<p>After conducting some spectral validations to check that STLAB reproduces these stimuli faithfully, all that remains is to make video files for the presentation. Here we make a video file that will present a 2 second melanopic pulse half way through a minute of the background spectrum.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyplr.stlab</span> <span class="kn">import</span> <span class="n">background_pulse_protocol</span>

<span class="c1"># Print the settings and make video files</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The background settings are: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">background_settings</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The stimulus settings are: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modulation_settings</span><span class="p">))</span>
<span class="n">background_pulse_protocol</span><span class="p">(</span><span class="n">background_spec</span><span class="o">=</span><span class="n">background_settings</span><span class="p">,</span>
                          <span class="n">pre_pulse_duration</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span>
                          <span class="n">pulse_spec</span><span class="o">=</span><span class="n">modulation_settings</span><span class="p">,</span>
                          <span class="n">pulse_duration</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">post_pulse_duration</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span>
                          <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;melanopsin_pulse&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The background settings are: [454, 0, 0, 0, 0, 0, 0, 1393, 0, 0]
The stimulus settings are: [0, 0, 0, 236, 1061, 0, 0, 0, 3834, 4094]
&#34;melanopsin_pulse.dsf&#34; saved in the current working directory.
</pre></div></div>
</div>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/orange_eye.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">PyPlr</a></h1>



<p class="blurb">A Python software for researching the pupillary light reflex.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=PyPlr&repo=cvd_pupillometry&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="02_purpose.html">Purpose</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_example_protocols.html">Example protocols</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="06_example_analyses.html">Example analyses</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="06a_pipr_analysis_pipeline.html">PIPR preprocessing pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="06b_pupil_core_timing_analysis.html">Pupil Core device timing</a></li>
<li class="toctree-l2"><a class="reference internal" href="06c_finding_stlab_settings.html">Matching spectra for <em>a</em>-opic irradiance with STLAB</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Silent substitution with STLAB</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="07_api.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_developers.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_funding.html">Funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_citation.html">Citation</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://pypi.org/project/pyplr/">PyPi</a></li>
    
    <li class="toctree-l1"><a href="https://www.biorxiv.org/content/10.1101/2021.06.02.446731v1">bioRxiv preprint</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="06_example_analyses.html">Example analyses</a><ul>
      <li>Previous: <a href="06c_finding_stlab_settings.html" title="previous chapter">Matching spectra for <em>a</em>-opic irradiance with STLAB</a></li>
      <li>Next: <a href="07_api.html" title="next chapter">API documentation</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Joel T. Martin and Manuel Spitschan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/06d_silent_substitution_STLAB.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>