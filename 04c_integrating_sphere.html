
<!DOCTYPE html>

<html>
  <head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XSBE1SFW8S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XSBE1SFW8S');
</script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Integrating sphere &#8212; PyPlr v1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Analysis of pupil data" href="04d_analysis.html" />
    <link rel="prev" title="Spectra Tune Lab light source" href="04b_stlab_light_source.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Integrating-sphere">
<h1>Integrating sphere<a class="headerlink" href="#Integrating-sphere" title="Permalink to this headline">¶</a></h1>
<p>For some experiments it may be sufficient to perform light stimulation with a standard computer monitor, but where research calls for advanced control over the geometry of retinal stimulation, a bespoke setup is required. One solution is to use a <a class="reference external" href="https://medical-dictionary.thefreedictionary.com/maxwellian+view">Maxwellian view</a> pupillometry system, where the light stimulus is focused onto an aperture positioned in front of the eye, or in the entrance plane of a pharmacologically dilated
pupil, and the consensual pupil response is measured from the other eye. But this approach requires optical engineering and resources that may not be available in the average research setting. As an alternative, we developed a low-cost integrating sphere that provides a full-field, ‘Ganzfeld’, stimulus and precludes the need for optical engineering, pharmacological dilation of the pupil, and strict fixation control on behalf of the participant.</p>
<section id="Construction">
<h2>Construction<a class="headerlink" href="#Construction" title="Permalink to this headline">¶</a></h2>
<p>We built the sphere from two 45 cm flanged acrylic half domes (<a class="reference external" href="https://www.projectplastics.co.uk/">Project Plastics Ltd</a>), each coated on the inside surface with <a class="reference external" href="https://aviantechnologies.com/product/avian-b-white-reflectance-coating/">Avian-B white reflectance coating</a> to scatter light homogenously. A 28 cm opening in one of the domes serves as a viewing port and an additional 7 cm (subtending ~9 degrees from the plane of the viewing port) opening opposite the viewing port was included
to allow for secondary stimuli (e.g., a fixation target) or to allow for exclusion of the foveal macular pigment from stimulation. On the same half of the sphere as the viewing port, a 30 mm entry port for the light source was cut at an angle of 22.5 deg from the top, such that it could not be seen directly when looking straight ahead. The sphere and STLAB were stabilised on a wooden fixing plate making it suitable for placement on a desk.</p>
<p><img alt="Integrating sphere" class="no-scaled-link" src="_images/setup.JPG" style="width: 500px;" /></p>
</section>
<section id="Calibration">
<h2>Calibration<a class="headerlink" href="#Calibration" title="Permalink to this headline">¶</a></h2>
<p>To build a calibrated forward model of our STLAB-sphere rig that represents what an observer actually sees when looking into it, we collected measurements with an external spectrometer positioned at the plane of the viewing port. The <code class="docutils literal notranslate"><span class="pre">pyplr.calibrate</span></code> module streamlines this process with a <code class="docutils literal notranslate"><span class="pre">SpectraTuneLabSampler()</span></code> class, which is just a sub-class of <code class="docutils literal notranslate"><span class="pre">pyplr.stlab.SpectraTuneLab</span></code> with added sampling methods and support for an external spectrometer. Any spectrometer with a python interface
can be integrated here with minimal effort, but we used an <a class="reference external" href="https://www.oceaninsight.com/products/spectrometers/microspectrometer/sts-series/sts-vis/">Ocean Optics STS-VIS</a>, supported by <code class="docutils literal notranslate"><span class="pre">pyplr.oceanops</span></code> and the <a class="reference external" href="https://pypi.org/project/seabreeze/">Seabreeze</a> Python library.</p>
<p>It would take a long time to sample every possible device setting, so we opted to sample the full range of intensities in steps of 63 for each LED.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyplr.calibrate</span> <span class="kn">import</span> <span class="n">SpectraTuneLabSampler</span>
<span class="kn">from</span> <span class="nn">pyplr.oceanops</span> <span class="kn">import</span> <span class="n">OceanOptics</span>

<span class="n">oo</span> <span class="o">=</span> <span class="n">OceanOptics</span><span class="o">.</span><span class="n">from_first_available</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">SpectraTuneLabSampler</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;***************&#39;</span><span class="p">,</span> <span class="n">external</span><span class="o">=</span><span class="n">oo</span><span class="p">)</span>

<span class="c1"># specify leds and intensities to sample</span>
<span class="n">leds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="n">intensities</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">65</span><span class="p">)]</span>

<span class="c1"># sample</span>
<span class="n">d</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">leds</span><span class="o">=</span><span class="n">leds</span><span class="p">,</span>
         <span class="n">intensities</span><span class="o">=</span><span class="n">intensities</span><span class="p">,</span>
         <span class="n">external</span><span class="o">=</span><span class="n">oo</span><span class="p">,</span>
         <span class="n">randomise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">make_dfs</span><span class="p">(</span><span class="n">save_csv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code instructs STLAB to cycle through all of the specified settings and obtain measurements with the on-board spectrometer and external spectrometer (if specified), and then finally to save the data to CSV format in the current working directory.</p>
<p>Calibrating the resulting OceanOptics data was an involved process complicated by the need to account for the effect of spectrometer PCB temperature and integration time on the raw data. Our pipeline is shown below, minus the code for fitting the data in MATLAB.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pyplr.oceanops</span> <span class="kn">import</span> <span class="n">predict_dark_counts</span><span class="p">,</span> <span class="n">calibrated_radiance</span>

<span class="c1"># Load Ocean Optics data</span>
<span class="n">oo_spectra_fname</span> <span class="o">=</span> <span class="s1">&#39;../data/S2_oo_led_intensity_spectra.csv&#39;</span>
<span class="n">oo_info_fname</span> <span class="o">=</span> <span class="s1">&#39;../data/S2_oo_led_intensity_info.csv&#39;</span>
<span class="n">oo_spectra</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">oo_spectra_fname</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>
<span class="n">oo_spectra</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">oo_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">oo_info_fname</span><span class="p">)</span>

<span class="c1"># Load a file with parameters accounting for the relationship</span>
<span class="c1"># between temperature and integration time. This was created by</span>
<span class="c1"># sampling the dark spectrum across a range of temperatures</span>
<span class="c1"># and times and fitting the data in MATLAB.</span>
<span class="n">darkcal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span>
    <span class="s1">&#39;../data/oo_dark_cal.txt&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Predict the dark spectrum for the temperatures and</span>
<span class="c1"># integration times of our measurements</span>
<span class="n">oo_dark_counts</span> <span class="o">=</span> <span class="n">predict_dark_counts</span><span class="p">(</span><span class="n">oo_info</span><span class="p">,</span> <span class="n">darkcal</span><span class="p">)</span>

<span class="c1"># Load some spectrometer constants</span>
<span class="n">cal_per_wl</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/oo_calibration.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">sensor_area_cm2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/oo_sensorArea.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Calculate calibrated radiance</span>
<span class="n">w_m2_nm</span> <span class="o">=</span> <span class="n">calibrated_radiance</span><span class="p">(</span>
    <span class="n">oo_spectra</span><span class="p">,</span>
    <span class="n">oo_info</span><span class="p">,</span>
    <span class="n">oo_dark_counts</span><span class="p">,</span>
    <span class="n">cal_per_wl</span><span class="p">,</span>
    <span class="n">sensor_area_cm2</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Clean up</span>
<span class="n">w_m2_nm</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oo_info</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">]</span>
<span class="n">w_m2_nm</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oo_info</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span>
<span class="n">w_m2_nm</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;led&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">w_m2_nm</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">w_m2_nm</span> <span class="o">=</span> <span class="n">w_m2_nm</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">w_m2_nm</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/S2_corrected_oo_spectra.csv&#39;</span><span class="p">)</span>
<span class="n">w_m2_nm</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>380</th>
      <th>381</th>
      <th>382</th>
      <th>383</th>
      <th>384</th>
      <th>385</th>
      <th>386</th>
      <th>387</th>
      <th>388</th>
      <th>389</th>
      <th>...</th>
      <th>771</th>
      <th>772</th>
      <th>773</th>
      <th>774</th>
      <th>775</th>
      <th>776</th>
      <th>777</th>
      <th>778</th>
      <th>779</th>
      <th>780</th>
    </tr>
    <tr>
      <th>led</th>
      <th>intensity</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000011</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>65</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>130</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>195</th>
      <td>0.000026</td>
      <td>0.000017</td>
      <td>0.000041</td>
      <td>0.000015</td>
      <td>0.000036</td>
      <td>0.000039</td>
      <td>0.000022</td>
      <td>0.000032</td>
      <td>0.000026</td>
      <td>0.000021</td>
      <td>...</td>
      <td>0.000022</td>
      <td>5.119073e-07</td>
      <td>0.000008</td>
      <td>0.000009</td>
      <td>0.000000</td>
      <td>0.000015</td>
      <td>0.000012</td>
      <td>0.000000</td>
      <td>0.000018</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>260</th>
      <td>0.000141</td>
      <td>0.000147</td>
      <td>0.000168</td>
      <td>0.000170</td>
      <td>0.000155</td>
      <td>0.000144</td>
      <td>0.000154</td>
      <td>0.000121</td>
      <td>0.000167</td>
      <td>0.000169</td>
      <td>...</td>
      <td>0.000088</td>
      <td>7.298278e-05</td>
      <td>0.000088</td>
      <td>0.000081</td>
      <td>0.000071</td>
      <td>0.000086</td>
      <td>0.000086</td>
      <td>0.000010</td>
      <td>0.000100</td>
      <td>0.000078</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">9</th>
      <th>3835</th>
      <td>0.003609</td>
      <td>0.004056</td>
      <td>0.003476</td>
      <td>0.003724</td>
      <td>0.002943</td>
      <td>0.003147</td>
      <td>0.003482</td>
      <td>0.002543</td>
      <td>0.003630</td>
      <td>0.004153</td>
      <td>...</td>
      <td>0.002318</td>
      <td>2.590713e-03</td>
      <td>0.002629</td>
      <td>0.002536</td>
      <td>0.002962</td>
      <td>0.002583</td>
      <td>0.002606</td>
      <td>0.002213</td>
      <td>0.002467</td>
      <td>0.002924</td>
    </tr>
    <tr>
      <th>3900</th>
      <td>0.003415</td>
      <td>0.003666</td>
      <td>0.003451</td>
      <td>0.003724</td>
      <td>0.002873</td>
      <td>0.003021</td>
      <td>0.003112</td>
      <td>0.002289</td>
      <td>0.003514</td>
      <td>0.004000</td>
      <td>...</td>
      <td>0.002279</td>
      <td>2.669694e-03</td>
      <td>0.002370</td>
      <td>0.002300</td>
      <td>0.002815</td>
      <td>0.002574</td>
      <td>0.002412</td>
      <td>0.002107</td>
      <td>0.002590</td>
      <td>0.002938</td>
    </tr>
    <tr>
      <th>3965</th>
      <td>0.003560</td>
      <td>0.003867</td>
      <td>0.003539</td>
      <td>0.003874</td>
      <td>0.003191</td>
      <td>0.003165</td>
      <td>0.003544</td>
      <td>0.002428</td>
      <td>0.003695</td>
      <td>0.004005</td>
      <td>...</td>
      <td>0.002134</td>
      <td>2.682856e-03</td>
      <td>0.002604</td>
      <td>0.002552</td>
      <td>0.002775</td>
      <td>0.002638</td>
      <td>0.002748</td>
      <td>0.002137</td>
      <td>0.002676</td>
      <td>0.002664</td>
    </tr>
    <tr>
      <th>4030</th>
      <td>0.003738</td>
      <td>0.003652</td>
      <td>0.003557</td>
      <td>0.003737</td>
      <td>0.002973</td>
      <td>0.003205</td>
      <td>0.003420</td>
      <td>0.002227</td>
      <td>0.003520</td>
      <td>0.003932</td>
      <td>...</td>
      <td>0.002444</td>
      <td>2.647269e-03</td>
      <td>0.002541</td>
      <td>0.002408</td>
      <td>0.002702</td>
      <td>0.002547</td>
      <td>0.002385</td>
      <td>0.002038</td>
      <td>0.002477</td>
      <td>0.002837</td>
    </tr>
    <tr>
      <th>4095</th>
      <td>0.003459</td>
      <td>0.004063</td>
      <td>0.003610</td>
      <td>0.004071</td>
      <td>0.003099</td>
      <td>0.003373</td>
      <td>0.003231</td>
      <td>0.002468</td>
      <td>0.003654</td>
      <td>0.004141</td>
      <td>...</td>
      <td>0.002274</td>
      <td>2.544598e-03</td>
      <td>0.002587</td>
      <td>0.002493</td>
      <td>0.002923</td>
      <td>0.002699</td>
      <td>0.002592</td>
      <td>0.002177</td>
      <td>0.002471</td>
      <td>0.002698</td>
    </tr>
  </tbody>
</table>
<p>640 rows × 401 columns</p>
</div></div>
</div>
<p>We can now pass the calibrated spectrometer data to <code class="docutils literal notranslate"><span class="pre">pyplr.calibrate.CalibrationContext(...)</span></code>, which will use linear interpolation to create lookup tables that predict the spectral output for the full range of device settings, along with the alphaopic irradiances, lux and radiance values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.4</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyplr.calibrate</span> <span class="kn">import</span> <span class="n">CalibrationContext</span>

<span class="n">cc</span> <span class="o">=</span> <span class="n">CalibrationContext</span><span class="p">(</span>
    <span class="s1">&#39;../data/S2_corrected_oo_spectra.csv&#39;</span><span class="p">,</span> <span class="n">binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">plot_calibrated_spectra</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/04c_integrating_sphere_6_0.png" src="_images/04c_integrating_sphere_6_0.png" />
</div>
</div>
<p>Of note, <code class="docutils literal notranslate"><span class="pre">CalibrationContext(...)</span></code> has a <code class="docutils literal notranslate"><span class="pre">.predict_spd(...)</span></code> method for predicting the spectral output of STLAB from a list of led-intensity values. Here we compare the predicted output to the actual measured output for 20 random device settings.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Load data from 40 random spectra</span>
<span class="n">test_specs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/S2_corrected_40_random_oo_spectra.csv&#39;</span><span class="p">)</span>
<span class="n">test_spec_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/S2_oo_40_random_spectra_info.csv&#39;</span><span class="p">)</span>

<span class="c1"># Set up figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">axs</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

<span class="c1"># Predict, measure and plot for 20 random inputs</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_spd</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span>
        <span class="n">test_spec_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;intensities&#39;</span><span class="p">]))</span>
    <span class="n">wls</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">test_specs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;measured&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;predicted&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="s1">&#39;Wavelength [nm]&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SPD (W/m$^2$/nm)&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">);</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../img/STLAB_sphere_measured_predicted.tiff&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/04c_integrating_sphere_8_0.png" src="_images/04c_integrating_sphere_8_0.png" />
</div>
</div>
<p>Looks like we can predict the spectral output with a good level of accuracy. There is also a method to fit curves to the unweighted radiance of spectral measurements.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">fit_curves</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/04c_integrating_sphere_10_0.png" src="_images/04c_integrating_sphere_10_0.png" />
</div>
</div>
<p>Nice and linear, overall, with a only a slight loss of linearity at the ends and for some channels more than others. If necessary, we can correct for this using the model fit parameters and the <code class="docutils literal notranslate"><span class="pre">.optimse(...)</span></code> method.</p>
</section>
<section id="Safety">
<h2>Safety<a class="headerlink" href="#Safety" title="Permalink to this headline">¶</a></h2>
<p>We evaluated the safety of our stimulation system in accordance with the <a class="reference external" href="https://landingpage.bsigroup.com/LandingPage/Undated?UPI=000000000030149289">British Standards Document on the Photobiological Safety of Lamps and Lamp Systems (BS EN 62471)</a>. Initial scoping measurements collected with a Photo Research SpectraScan PR-670 for all LEDs at 100% gave a luminance reading of 18000 cd/m<span class="math notranslate nohighlight">\(^2\)</span> at the plane of the viewing port.</p>
<p><strong>BS EN 62471: Section 4.1 (Annex ZB, page 40)</strong></p>
<blockquote>
<div><p>“Detailed spectral data is required if the luminance of the source exceeds 10<span class="math notranslate nohighlight">\(^4\)</span> cd/m<span class="math notranslate nohighlight">\(^{-2}\)</span>”</p>
</div></blockquote>
<p>The maximum output of our source exceeded this specification so we obtained detailed spectral measurements.</p>
<p><strong>BS EN 62471: Section 4.3.3</strong></p>
<blockquote>
<div><p>“To protect against retinal photochemical injury from chronic blue-light exposure, the integrated spectral radiance of the light source weighted against the blue-light hazard function, <span class="math notranslate nohighlight">\(B(\lambda)\)</span>, i.e., the blue light weighted radiance, <span class="math notranslate nohighlight">\(L_B\)</span>, shall not exceed the levels defined by:</p>
<p><span class="math notranslate nohighlight">\(L_B \cdot t = \sum_{700}^{300} \sum_{t} L_\lambda (\lambda, t) \cdot B(\lambda) \cdot \Delta t \cdot \Delta\lambda \le 10^6 J \cdot m^{-2} \cdot sr^{-1}\)</span> (for <span class="math notranslate nohighlight">\(t \le 10^4s\)</span>)</p>
<p><span class="math notranslate nohighlight">\(L_B = \sum_{700}^{300} \sum_{t} L_\lambda \cdot B(\lambda) \cdot \Delta\lambda \le 100\,W \cdot m^{-2} \cdot sr^{-1}\)</span> (for <span class="math notranslate nohighlight">\(t \gt 10^4\)</span>s)</p>
<p>Where:</p>
<p><span class="math notranslate nohighlight">\(L\lambda(\lambda, t)\)</span> is the spectral radiance in <span class="math notranslate nohighlight">\(W \cdot m^{-2} \cdot sr^{-1} \cdot nm^{-1}\)</span></p>
<p><span class="math notranslate nohighlight">\(B(\lambda)\)</span> is the blue light hazard weighting function</p>
<p><span class="math notranslate nohighlight">\(\Delta\lambda\)</span> is the bandwidth in nm</p>
<p><span class="math notranslate nohighlight">\(t\)</span> is the exposure duration in seconds”</p>
</div></blockquote>
<p>Using the minimum radiance limit for the retinal blue light hazard exposure limit, given as 100 <span class="math notranslate nohighlight">\(W \cdot m^{-2} \cdot sr^{-1}\)</span> for exposures of greater than 10000 s, we note that our source is below the retinal blue light hazard exposure limit. These findings were confirmed by processing the data with the NPL EyeLight software:</p>
<p>(Units are <span class="math notranslate nohighlight">\(W \cdot m^2 \cdot sr^{-1} \cdot nm^{-1}\)</span>)</p>
<ul class="simple">
<li><p>Raw Radiance: 71.5</p></li>
<li><p>Blue Light Corrected Radiance: 18.8</p></li>
<li><p>EyeLight: 16.8</p></li>
</ul>
<img alt="_images/EyeLight.png" src="_images/EyeLight.png" />
<p><strong>Section 4.2.1 (Annex ZB, page 40)</strong></p>
<blockquote>
<div><p>“When the luminance of the source is adequately high (<span class="math notranslate nohighlight">\(\gt 10\,cd \cdot m^{-2}\)</span>), and the exposure duration is greater the 0.25 s, a 3 mm pupil diameter (7mm<span class="math notranslate nohighlight">\(^2\)</span> area) was used to derive the exposure limit”</p>
</div></blockquote>
<p>Given that our sphere may be used in a dark room following a period of dark adaptation, pupil diameter will be greater than 3 mm at the start of exposure. Typical experimental exposures will also be greater than 0.25 s.</p>
<p>Pupil ratio <span class="math notranslate nohighlight">\((\frac{7}{3})^2\)</span> = 5.4</p>
<p>To take this into account we applied a pupil correction factor of 6, which reduces the retinal blue light hazard exposure limit to 16.6 <span class="math notranslate nohighlight">\(W \cdot m^2 \cdot sr^{-1}\)</span></p>
<p>In conclusion, when running the source at 100% and applying a safety factor to correct for the pupil size, our stimulation system is above the radiance retinal blue light hazard exposure limit value of 100 <span class="math notranslate nohighlight">\(W \cdot m^2 \cdot sr^{-1}\)</span> for an exposure of 10000 s.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/orange_eye.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">PyPlr</a></h1>



<p class="blurb">A Python software for researching the pupillary light reflex.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=PyPlr&repo=cvd_pupillometry&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="02_purpose.html">Purpose</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="04_overview.html">Overview</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="04a_pyplr_and_pupil_core.html"><em>PyPlr</em> and Pupil Core</a></li>
<li class="toctree-l2"><a class="reference internal" href="04b_stlab_light_source.html">Spectra Tune Lab light source</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Integrating sphere</a></li>
<li class="toctree-l2"><a class="reference internal" href="04d_analysis.html">Analysis of pupil data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="05_example_protocols.html">Example protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_example_analyses.html">Example analyses</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_api.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_developers.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_funding.html">Funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_citation.html">Citation</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://pypi.org/project/pyplr/">PyPi</a></li>
    
    <li class="toctree-l1"><a href="https://link.springer.com/article/10.3758/s13428-021-01759-3">Publication</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="04_overview.html">Overview</a><ul>
      <li>Previous: <a href="04b_stlab_light_source.html" title="previous chapter">Spectra Tune Lab light source</a></li>
      <li>Next: <a href="04d_analysis.html" title="next chapter">Analysis of pupil data</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Joel T. Martin and Manuel Spitschan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/04c_integrating_sphere.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>