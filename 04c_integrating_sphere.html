
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Integrating sphere &#8212; PyPlr v1.0 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Analysis of pupil data" href="04d_analysis.html" />
    <link rel="prev" title="Spectra Tune Lab light source" href="04b_stlab_light_source.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Integrating-sphere">
<h1>Integrating sphere<a class="headerlink" href="#Integrating-sphere" title="Permalink to this headline">¶</a></h1>
<p>For some experiments it may be sufficient to perform light stimulation with a standard computer monitor, but where research calls for advanced control over the geometry of retinal stimulation, a bespoke setup is required. One solution is to use a Maxwellian view pupillometry system, where the light stimulus is focused onto an aperture positioned in front of the eye, or in the entrance plane of a pharmacologically dilated pupil, and the consensual pupil response is measured from the other eye.
But this approach requires optical engineering and resources that may not be available in the average research setting. As an alternative, we developed a low-cost integrating sphere that provides a full-field, ‘Ganzfeld’, stimulus and precludes the need for optical engineering, pharmacological dilation of the pupil, and strict fixation control on behalf of the participant.</p>
<div class="section" id="Construction">
<h2>Construction<a class="headerlink" href="#Construction" title="Permalink to this headline">¶</a></h2>
<p>We built the sphere from two 45 cm flanged acrylic half domes (<a class="reference external" href="https://www.projectplastics.co.uk/">Project Plastics Ltd</a>), each coated on the inside surface with <a class="reference external" href="https://aviantechnologies.com/product/avian-b-white-reflectance-coating/">Avian-B white reflectance coating</a> to scatter light homogenously. A 28 cm opening in one of the domes serves as a viewing port and an additional 7 cm (subtending ~9 degrees from the plane of the viewing port) opening opposite the viewing port was included
to allow for secondary stimuli (e.g., a fixation target) or to allow for exclusion of the foveal macular pigment from stimulation. On the same half of the sphere as the viewing port, a 30 mm entry port for the light source was cut at an angle of 22.5 deg from the top, such that it could not be seen directly when looking straight ahead. The sphere and STLAB were stabilised on a wooden fixing plate making it suitable for placement on a desk.</p>
<p><img alt="Integrating sphere" class="no-scaled-link" src="_images/setup.JPG" style="width: 500px;" /></p>
</div>
<div class="section" id="Calibration">
<h2>Calibration<a class="headerlink" href="#Calibration" title="Permalink to this headline">¶</a></h2>
<p>To build a calibrated forward model of our STLAB-sphere rig that is representative of what an observer actually sees when looking into it, we collected measurements with an external spectrometer positioned at the plane of the viewing port. <code class="docutils literal notranslate"><span class="pre">pyplr.calibrate</span></code> simplifies this with a <code class="docutils literal notranslate"><span class="pre">SpectraTuneLabSampler</span></code> class, which is just a sub-class of <code class="docutils literal notranslate"><span class="pre">pyplr.stlab.SpectraTuneLab</span></code> with added sampling methods and support for an external spectrometer. Any spectrometer with a python interface can be
integrated here with minimal effort, but we used an <a class="reference external" href="https://www.oceaninsight.com/products/spectrometers/microspectrometer/sts-series/sts-vis/">Ocean Optics STS-VIS</a>, which is supported by <code class="docutils literal notranslate"><span class="pre">pyplr.oceanops</span></code> and the <a class="reference external" href="https://pypi.org/project/seabreeze/">Seabreeze</a> Python library.</p>
<p>It would take a long time to sample every possible device setting, so we opted to sample the full range of intensities in steps of 65 for each LED.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyplr.calibrate</span> <span class="kn">import</span> <span class="n">SpectraTuneLabSampler</span>
<span class="kn">from</span> <span class="nn">pyplr.oceanops</span> <span class="kn">import</span> <span class="n">OceanOptics</span>

<span class="n">oo</span> <span class="o">=</span> <span class="n">OceanOptics</span><span class="o">.</span><span class="n">from_first_available</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">SpectraTuneLabSampler</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;***************&#39;</span><span class="p">,</span> <span class="n">external</span><span class="o">=</span><span class="n">oo</span><span class="p">)</span>

<span class="c1"># specify leds and intensities to sample</span>
<span class="n">leds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="n">intensities</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">65</span><span class="p">)]</span>

<span class="c1"># sample</span>
<span class="n">d</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">leds</span><span class="o">=</span><span class="n">leds</span><span class="p">,</span>
         <span class="n">intensities</span><span class="o">=</span><span class="n">intensities</span><span class="p">,</span>
         <span class="n">external</span><span class="o">=</span><span class="n">oo</span><span class="p">,</span>
         <span class="n">randomise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">make_dfs</span><span class="p">(</span><span class="n">save_csv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code instructs STLAB to cycle through all of the specified settings and obtain measurements with the on-board spectrometer and external spectrometer (if specified), and then finally to save the data to CSV format in the current working directory.</p>
<p>Calibrating the resulting OceanOptics data turned out to be an involved process that was complicated by the need to account for the effect of spectrometer PCB temperature and integration time on the raw data. Our pipeline is shown below, minus the code for fitting the data in MATLAB.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;notebook&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyplr.oceanops</span> <span class="kn">import</span> <span class="n">predict_dark_counts</span><span class="p">,</span> <span class="n">calibrated_radiance</span>

<span class="c1"># load Ocean Optics data</span>
<span class="n">oo_spectra_fname</span> <span class="o">=</span> <span class="s1">&#39;../data/S1_oo_led_intensity_spectra.csv&#39;</span>
<span class="n">oo_info_fname</span> <span class="o">=</span> <span class="s1">&#39;../data/S1_oo_led_intensity_info.csv&#39;</span>
<span class="n">oo_spectra</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">oo_spectra_fname</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>
<span class="n">oo_spectra</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">oo_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">oo_info_fname</span><span class="p">)</span>

<span class="c1"># load a file with parameters accounting for the relationship</span>
<span class="c1"># between temperature and integration time. This was created by</span>
<span class="c1"># sampling the dark spectrum across a range of integration times</span>
<span class="c1"># and temperatures and fitting the data in MATLAB.</span>
<span class="n">darkcal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span>
    <span class="s1">&#39;../data/oo_dark_cal.txt&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># predict the dark spectrum for the temperatures and</span>
<span class="c1"># integration times of our measurements</span>
<span class="n">oo_dark_counts</span> <span class="o">=</span> <span class="n">predict_dark_counts</span><span class="p">(</span><span class="n">oo_info</span><span class="p">,</span> <span class="n">darkcal</span><span class="p">)</span>

<span class="c1"># load some spectrometer constants</span>
<span class="n">cal_per_wl</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/oo_calibration.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">sensor_area_cm2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/oo_sensorArea.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># calculate calibrated radiance</span>
<span class="n">w_m2_nm</span> <span class="o">=</span> <span class="n">calibrated_radiance</span><span class="p">(</span>
    <span class="n">oo_spectra</span><span class="p">,</span>
    <span class="n">oo_info</span><span class="p">,</span>
    <span class="n">oo_dark_counts</span><span class="p">,</span>
    <span class="n">cal_per_wl</span><span class="p">,</span>
    <span class="n">sensor_area_cm2</span><span class="p">)</span>

<span class="c1"># clean up</span>
<span class="n">w_m2_nm</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oo_info</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">]</span>
<span class="n">w_m2_nm</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oo_info</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span>
<span class="n">w_m2_nm</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;led&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">w_m2_nm</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">w_m2_nm</span> <span class="o">=</span> <span class="n">w_m2_nm</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">w_m2_nm</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/S1_corrected_oo_spectra.csv&#39;</span><span class="p">)</span>
<span class="n">w_m2_nm</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>380</th>
      <th>381</th>
      <th>382</th>
      <th>383</th>
      <th>384</th>
      <th>385</th>
      <th>386</th>
      <th>387</th>
      <th>388</th>
      <th>389</th>
      <th>...</th>
      <th>771</th>
      <th>772</th>
      <th>773</th>
      <th>774</th>
      <th>775</th>
      <th>776</th>
      <th>777</th>
      <th>778</th>
      <th>779</th>
      <th>780</th>
    </tr>
    <tr>
      <th>led</th>
      <th>intensity</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>65</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>130</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>195</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000004</td>
      <td>0.000000</td>
      <td>0.000010</td>
      <td>0.000016</td>
      <td>0.000002</td>
      <td>0.000032</td>
      <td>0.000013</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000002</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000003</td>
      <td>5.243781e-07</td>
      <td>0.000000</td>
      <td>0.000009</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>260</th>
      <td>0.000120</td>
      <td>0.000078</td>
      <td>0.000143</td>
      <td>0.000142</td>
      <td>0.000143</td>
      <td>0.000136</td>
      <td>0.000148</td>
      <td>0.000136</td>
      <td>0.000151</td>
      <td>0.000161</td>
      <td>...</td>
      <td>0.000067</td>
      <td>0.000062</td>
      <td>0.000076</td>
      <td>0.000079</td>
      <td>0.000058</td>
      <td>0.000078</td>
      <td>6.537223e-05</td>
      <td>0.000000</td>
      <td>0.000086</td>
      <td>0.000082</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">9</th>
      <th>3835</th>
      <td>0.004805</td>
      <td>0.004619</td>
      <td>0.004544</td>
      <td>0.004574</td>
      <td>0.004250</td>
      <td>0.003880</td>
      <td>0.004228</td>
      <td>0.003484</td>
      <td>0.003731</td>
      <td>0.004273</td>
      <td>...</td>
      <td>0.002943</td>
      <td>0.003430</td>
      <td>0.003303</td>
      <td>0.003304</td>
      <td>0.003584</td>
      <td>0.003266</td>
      <td>3.256202e-03</td>
      <td>0.002860</td>
      <td>0.003361</td>
      <td>0.003514</td>
    </tr>
    <tr>
      <th>3900</th>
      <td>0.004468</td>
      <td>0.004790</td>
      <td>0.004257</td>
      <td>0.004693</td>
      <td>0.003956</td>
      <td>0.003621</td>
      <td>0.004206</td>
      <td>0.003458</td>
      <td>0.003854</td>
      <td>0.004562</td>
      <td>...</td>
      <td>0.002951</td>
      <td>0.003260</td>
      <td>0.003288</td>
      <td>0.003022</td>
      <td>0.003308</td>
      <td>0.003081</td>
      <td>3.191800e-03</td>
      <td>0.002890</td>
      <td>0.003207</td>
      <td>0.003290</td>
    </tr>
    <tr>
      <th>3965</th>
      <td>0.004797</td>
      <td>0.005050</td>
      <td>0.004623</td>
      <td>0.004957</td>
      <td>0.004305</td>
      <td>0.004161</td>
      <td>0.004243</td>
      <td>0.003879</td>
      <td>0.003819</td>
      <td>0.004699</td>
      <td>...</td>
      <td>0.003149</td>
      <td>0.003538</td>
      <td>0.003434</td>
      <td>0.003165</td>
      <td>0.003345</td>
      <td>0.003596</td>
      <td>3.275223e-03</td>
      <td>0.002831</td>
      <td>0.003219</td>
      <td>0.003477</td>
    </tr>
    <tr>
      <th>4030</th>
      <td>0.004834</td>
      <td>0.005387</td>
      <td>0.004674</td>
      <td>0.005162</td>
      <td>0.004448</td>
      <td>0.004247</td>
      <td>0.004708</td>
      <td>0.004041</td>
      <td>0.004074</td>
      <td>0.005171</td>
      <td>...</td>
      <td>0.003273</td>
      <td>0.003528</td>
      <td>0.003760</td>
      <td>0.003473</td>
      <td>0.003938</td>
      <td>0.003540</td>
      <td>3.482008e-03</td>
      <td>0.003338</td>
      <td>0.003347</td>
      <td>0.003911</td>
    </tr>
    <tr>
      <th>4095</th>
      <td>0.005099</td>
      <td>0.005310</td>
      <td>0.005037</td>
      <td>0.005156</td>
      <td>0.004420</td>
      <td>0.004231</td>
      <td>0.004623</td>
      <td>0.004095</td>
      <td>0.004487</td>
      <td>0.004984</td>
      <td>...</td>
      <td>0.003231</td>
      <td>0.003729</td>
      <td>0.003792</td>
      <td>0.003311</td>
      <td>0.003832</td>
      <td>0.003505</td>
      <td>3.427454e-03</td>
      <td>0.003110</td>
      <td>0.003654</td>
      <td>0.003819</td>
    </tr>
  </tbody>
</table>
<p>640 rows × 401 columns</p>
</div></div>
</div>
<p>We can now pass the calibrated spectrometer data to <code class="docutils literal notranslate"><span class="pre">pyplr.calibrate.CalibrationContext(...)</span></code>. This will use linear interpolation to create lookup tables that predict the spectral output for the full range of device settings, along with the alphaopic irradiances, lux and radiance values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyplr.calibrate</span> <span class="kn">import</span> <span class="n">CalibrationContext</span>

<span class="n">cc</span> <span class="o">=</span> <span class="n">CalibrationContext</span><span class="p">(</span>
    <span class="s1">&#39;../data/S1_corrected_oo_spectra.csv&#39;</span><span class="p">,</span> <span class="n">binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">plot_calibrated_spectra</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/04c_integrating_sphere_7_0.png" src="_images/04c_integrating_sphere_7_0.png" />
</div>
</div>
<p>Crucially, <code class="docutils literal notranslate"><span class="pre">CalibrationContext(...)</span></code> has a <code class="docutils literal notranslate"><span class="pre">.predict_spd(...)</span></code> method which we can use to predict the spectral output from a list of STLAB led-intensity values. Here we compare the predicted output to the actual mneasured output for 40 random device settings.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># load data from 40 random spectra</span>
<span class="n">test_specs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/S2_corrected_40_random_oo_spectra.csv&#39;</span><span class="p">)</span>
<span class="n">test_spec_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/S2_oo_40_random_spectra_info.csv&#39;</span><span class="p">)</span>

<span class="c1"># set up fgiure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">axs</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

<span class="c1"># predict, measure and plot for 8 random inputs</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_spd</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span>
        <span class="n">test_spec_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;intensities&#39;</span><span class="p">]))</span>
    <span class="n">wls</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">test_specs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;measured&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;predicted&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="s1">&#39;Wavelength [nm]&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;W/m$^2$/nm&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/04c_integrating_sphere_9_0.png" src="_images/04c_integrating_sphere_9_0.png" />
</div>
</div>
</div>
<div class="section" id="Safety">
<h2>Safety<a class="headerlink" href="#Safety" title="Permalink to this headline">¶</a></h2>
<p>Pending…</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/orange_eye.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">PyPlr</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="02_purpose.html">Purpose</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="04_overview.html">Overview</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="04a_pyplr_and_pupil_core.html"><em>PyPlr</em> and Pupil Core</a></li>
<li class="toctree-l2"><a class="reference internal" href="04b_stlab_light_source.html">Spectra Tune Lab light source</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Integrating sphere</a></li>
<li class="toctree-l2"><a class="reference internal" href="04d_analysis.html">Analysis of pupil data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="05_example_protocols.html">Example protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_example_analyses.html">Example analyses</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_api.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_developers.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_funding.html">Funding</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="04_overview.html">Overview</a><ul>
      <li>Previous: <a href="04b_stlab_light_source.html" title="previous chapter">Spectra Tune Lab light source</a></li>
      <li>Next: <a href="04d_analysis.html" title="next chapter">Analysis of pupil data</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Joel T. Martin and Manuel Spitschan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/04c_integrating_sphere.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>