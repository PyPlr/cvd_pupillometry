
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matching spectra for a-opic irradiance with STLAB &#8212; PyPlr v1.0 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API documentation" href="07_api.html" />
    <link rel="prev" title="Pupil Core device timing" href="06b_pupil_core_timing_analysis.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Matching-spectra-for-a-opic-irradiance-with-STLAB">
<h1>Matching spectra for <em>a</em>-opic irradiance with STLAB<a class="headerlink" href="#Matching-spectra-for-a-opic-irradiance-with-STLAB" title="Permalink to this headline">Â¶</a></h1>
<p>When designing stimuli with STLAB, you may need to find the settings that most closely match a spectrum you measured elsewhere, which requires some linear algebra. In this example we are aiming to match the spectral output of a NeurOptics PLR-3000 automated pupillometer, which administers light stimuli with 4 white LEDs. We measured the spectral output of the PLR-3000 with an OceanOptics STS-VIS spectrometer at the usual eye position and calibrated using our <a class="reference internal" href="04c_integrating_sphere.html#Calibration"><span class="std std-ref">standard
pipeline</span></a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyplr.CIE</span> <span class="kn">import</span> <span class="n">get_CIES026</span>

<span class="c1"># Load data</span>
<span class="n">plr3000</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;../data/PLR-3000_oo_calibrated_spectra.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;uW&#39;</span><span class="p">)</span>
<span class="n">plr3000</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">plr3000</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

<span class="c1"># Plot spectra</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">(</span><span class="n">plr3000</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;uW&#39;</span><span class="p">,</span>
                      <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span>
                      <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;w/m2/nm&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;uW&#39;</span><span class="p">,</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">specs</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;w/m2/nm&#39;</span><span class="p">,</span>
    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;uW&#39;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;uW&#39;</span><span class="p">,</span>
    <span class="n">estimator</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;W/m$^2$/nm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PLR-3000 spectral measurements&#39;</span><span class="p">)</span>

<span class="c1"># Plot a-opic irradiances</span>
<span class="n">sss</span> <span class="o">=</span> <span class="n">get_CIES026</span><span class="p">(</span><span class="n">asdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sss</span> <span class="o">=</span> <span class="n">sss</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plr_3k_ao</span> <span class="o">=</span> <span class="n">plr3000</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sss</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">plr_3k_ao</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                 <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uW&#39;</span><span class="p">],</span>
                       <span class="n">var_name</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aopic&#39;</span><span class="p">],</span>
                       <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;irradiance&#39;</span><span class="p">))</span>
<span class="n">f2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;uW&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;irradiance&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;aopic&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;W/m$^2$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PLR-3000 $a$-opic irradiances&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06c_finding_stlab_settings_1_0.png" src="_images/06c_finding_stlab_settings_1_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06c_finding_stlab_settings_1_1.png" src="_images/06c_finding_stlab_settings_1_1.png" />
</div>
</div>
<p>In order to find the right STLAB settings, we need to make a <code class="docutils literal notranslate"><span class="pre">CalibrationContext</span></code> from our calibrated OceanOptics data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyplr.calibrate</span> <span class="kn">import</span> <span class="n">CalibrationContext</span>

<span class="n">cc</span> <span class="o">=</span> <span class="n">CalibrationContext</span><span class="p">(</span>
    <span class="s1">&#39;../data/S2_corrected_oo_spectra.csv&#39;</span><span class="p">,</span> <span class="n">binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">plot_calibrated_spectra</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06c_finding_stlab_settings_3_0.png" src="_images/06c_finding_stlab_settings_3_0.png" />
</div>
</div>
<p>Now we can start searching for the STLAB settings that match the PLR-3000 settings for <em>a</em>-opic irradiance. We will focus on the 180 uW setting to keep things simple. For all possible combinations in 10 choose 5 (one LED for each photoreceptor class), we use linear algebra to work out the input fraction of the chosen LEDs that is required for matching the spectrum. Only those solutions where the input fractions are between 0 and 1 are valid, because eventually we will need to convert these to
12-bit integers for STLAB.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># The PLR-3000 setting we care about</span>
<span class="n">uW_setting</span> <span class="o">=</span> <span class="mi">180</span>

<span class="c1"># Photoreceptors classes we are aiming to match</span>
<span class="n">opsins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;Mel&#39;</span><span class="p">,</span> <span class="s1">&#39;Rods&#39;</span><span class="p">]</span>

<span class="c1"># An LED for each photoreceptors</span>
<span class="n">num_leds</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># List to store valid settings</span>
<span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through all possible combinations in 10 choose 5</span>
<span class="k">for</span> <span class="n">choose</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">num_leds</span><span class="p">):</span>

    <span class="c1"># Get the irradiances for each LED at maximum</span>
    <span class="n">settings_to_irradiances</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">aopic</span><span class="o">.</span><span class="n">loc</span><span class="p">[[(</span><span class="n">led</span><span class="p">,</span> <span class="mi">4095</span><span class="p">)</span> <span class="k">for</span> <span class="n">led</span> <span class="ow">in</span> <span class="n">choose</span><span class="p">],</span> <span class="n">opsins</span><span class="p">]</span>

    <span class="c1"># Take the inverse</span>
    <span class="n">irradiances_to_settings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">settings_to_irradiances</span><span class="p">)</span>

    <span class="c1"># Calculate the required input fraction for the chosen LEDs</span>
    <span class="n">plr_irradiances</span> <span class="o">=</span> <span class="n">plr_3k_ao</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">uW_setting</span><span class="p">,</span> <span class="n">opsins</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">plr_irradiances</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">irradiances_to_settings</span><span class="p">)</span>

    <span class="c1"># Keep the settings where all values are greater than 0 and less then 1</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">settings</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">settings</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">uW_setting</span><span class="p">,</span> <span class="n">choose</span><span class="p">,</span> <span class="n">settings</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; settings found&#39;</span><span class="p">)</span>
<span class="n">keep</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

&gt; 18 settings found
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(180,
  (0, 1, 2, 6, 7),
  array([0.00517166, 0.32173031, 0.02026771, 0.19441607, 0.0164306 ])),
 (180,
  (0, 1, 2, 6, 8),
  array([0.31550785, 0.05958875, 0.10219134, 0.20210005, 0.06132067])),
 (180,
  (0, 1, 2, 6, 9),
  array([0.3583914 , 0.02262412, 0.11388467, 0.20229605, 0.07338902])),
 (180,
  (0, 1, 3, 6, 7),
  array([0.01684065, 0.31693341, 0.01842986, 0.19397591, 0.01666438])),
 (180,
  (0, 1, 3, 6, 8),
  array([0.40155686, 0.01397228, 0.09859531, 0.20033016, 0.06598839])),
 (180,
  (0, 2, 3, 6, 9),
  array([0.40011401, 0.06656192, 0.04605868, 0.20147622, 0.07599868])),
 (180,
  (0, 2, 4, 6, 7),
  array([0.41946373, 0.08731701, 0.04332805, 0.17244175, 0.02821919])),
 (180,
  (0, 2, 4, 6, 8),
  array([0.38995726, 0.11689858, 0.00506435, 0.200176  , 0.06646312])),
 (180,
  (0, 2, 4, 6, 9),
  array([0.38655782, 0.11954637, 0.00182771, 0.2016076 , 0.07561016])),
 (180,
  (0, 2, 5, 6, 7),
  array([0.40016009, 0.10775283, 0.05472756, 0.15665175, 0.03607427])),
 (180,
  (0, 2, 5, 6, 8),
  array([0.3873756 , 0.11958843, 0.00513457, 0.19941887, 0.06819887])),
 (180,
  (0, 2, 5, 6, 9),
  array([0.38560989, 0.12052573, 0.00182263, 0.20135211, 0.0763111 ])),
 (180,
  (0, 3, 4, 6, 7),
  array([0.44201214, 0.07566702, 0.04067575, 0.17197971, 0.0284574 ])),
 (180,
  (0, 3, 4, 6, 8),
  array([0.41989687, 0.1015923 , 0.00106964, 0.19986998, 0.06721641])),
 (180,
  (0, 3, 5, 6, 7),
  array([0.42903038, 0.09205737, 0.05065177, 0.15726557, 0.03577909])),
 (180,
  (0, 3, 5, 6, 8),
  array([0.41950423, 0.10207723, 0.00106514, 0.19971146, 0.06758008])),
 (180,
  (0, 3, 6, 7, 9),
  array([0.41847277, 0.10241046, 0.19974393, 0.00152053, 0.07239993])),
 (180,
  (0, 3, 6, 8, 9),
  array([0.419022  , 0.10233208, 0.200328  , 0.0458547 , 0.02430788]))]
</pre></div></div>
</div>
<p>So there are 18 solutions to the problem using 5 LEDs. Next, we need to convert the input fractions to 12-bit integers for STLAB.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Lists to store settings and predicted spectra</span>
<span class="n">settings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">predicted</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Remove the index</span>
<span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">keep</span> <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

<span class="c1"># Loop over settings</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
    <span class="n">leds</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Convert to 12-bit integer and save LED settings</span>
    <span class="n">intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4095</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span>
    <span class="k">for</span> <span class="n">led</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">leds</span><span class="p">,</span> <span class="n">intensities</span><span class="p">):</span>
        <span class="n">spec</span><span class="p">[</span><span class="n">led</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="c1"># Get predicted spectrum</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">predict_spd</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="c1"># Add to lists</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">predicted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

<span class="c1"># Make DFs</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
<span class="n">predicted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
<span class="n">predicted</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># In theory it doesn&#39;t matter which one we use, but let&#39;s define</span>
<span class="c1"># the &#39;best&#39; solution as the one with the least squared error</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
    <span class="n">plr3000</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">uW_setting</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

<span class="n">optimal_predicted</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best</span><span class="p">]</span>
<span class="n">optimal_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Time to visualise the solutions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plr3000</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">uW_setting</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PLR-3000: </span><span class="si">{}</span><span class="s1"> uW&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">uW_setting</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plr3000</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="n">optimal_predicted</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Optimal STLAB: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">optimal_settings</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">p</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (nm)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SPD (W/m$^2$/nm)&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../img/PLR-3000-STLAB-stimuli.tiff&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/06c_finding_stlab_settings_9_0.png" src="_images/06c_finding_stlab_settings_9_0.png" />
</div>
</div>
<p>All that remains is to make a video file for use with STLAB.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyplr.stlab</span> <span class="kn">import</span> <span class="n">pulse_protocol</span><span class="p">,</span> <span class="n">video_file_to_dict</span>
<span class="n">pulse_protocol</span><span class="p">(</span><span class="n">pulse_spec</span><span class="o">=</span><span class="n">optimal_settings</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
               <span class="n">pulse_duration</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
               <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;PLR-3000-</span><span class="si">{}</span><span class="s1">-mw&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uW_setting</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#34;PLR-3000-180-mw.dsf&#34; saved in the current working directory.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">vf</span> <span class="o">=</span> <span class="n">video_file_to_dict</span><span class="p">(</span><span class="s1">&#39;PLR-3000-180-mw.dsf&#39;</span><span class="p">)</span>
<span class="n">vf</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;header&#39;: {&#39;version&#39;: 1,
  &#39;model&#39;: &#39;VEGA10&#39;,
  &#39;channels&#39;: 10,
  &#39;spectracount&#39;: 4,
  &#39;transitionsCount&#39;: 4,
  &#39;fluxReference&#39;: 0,
  &#39;repeats&#39;: 1},
 &#39;metadata&#39;: {&#39;creation_time&#39;: &#39;2021-05-27 08:33:12.766758&#39;,
  &#39;creator&#39;: &#39;jtm&#39;,
  &#39;protocol&#39;: &#39;pulse&#39;,
  &#39;pulse_spec&#39;: &#39;[21, 1317, 83, 0, 0, 0, 796, 67, 0, 0]&#39;,
  &#39;pulse_duration&#39;: &#39;1000&#39;},
 &#39;spectra&#39;: [[21, 1317, 83, 0, 0, 0, 796, 67, 0, 0],
  [21, 1317, 83, 0, 0, 0, 796, 67, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]],
 &#39;transitions&#39;: [{&#39;spectrum&#39;: 0, &#39;power&#39;: 100, &#39;time&#39;: 0, &#39;flags&#39;: 0},
  {&#39;spectrum&#39;: 1, &#39;power&#39;: 100, &#39;time&#39;: 1000, &#39;flags&#39;: 0},
  {&#39;spectrum&#39;: 2, &#39;power&#39;: 100, &#39;time&#39;: 1000, &#39;flags&#39;: 0},
  {&#39;spectrum&#39;: 3, &#39;power&#39;: 100, &#39;time&#39;: 1100, &#39;flags&#39;: 0}]}
</pre></div></div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/orange_eye.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">PyPlr</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="02_purpose.html">Purpose</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_example_protocols.html">Example protocols</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="06_example_analyses.html">Example analyses</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="06a_pipr_analysis_pipeline.html">PIPR analysis pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="06b_pupil_core_timing_analysis.html">Pupil Core device timing</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Matching spectra for <em>a</em>-opic irradiance with STLAB</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="07_api.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_developers.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_funding.html">Funding</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="06_example_analyses.html">Example analyses</a><ul>
      <li>Previous: <a href="06b_pupil_core_timing_analysis.html" title="previous chapter">Pupil Core device timing</a></li>
      <li>Next: <a href="07_api.html" title="next chapter">API documentation</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Joel T. Martin and Manuel Spitschan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/06c_finding_stlab_settings.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>